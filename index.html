<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>FEUER KATALOG</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Metal+Mania&family=Oswald:wght@300;400;500;600;700&family=Barlow+Condensed:wght@400;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --black: #0a0a0a;
  --black2: #111111;
  --black3: #1a1a1a;
  --black4: #222222;
  --red: #cc0000;
  --red2: #ff1a1a;
  --red3: #ff4444;
  --red-glow: rgba(204,0,0,0.35);
  --white: #f0f0f0;
  --white2: #c0c0c0;
  --grey: #555555;
  --radius: 0px;
  --radius-sm: 2px;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

::selection { background: var(--red); color: var(--white); }

html, body {
  font-family: 'Oswald', sans-serif;
  background: var(--black);
  color: var(--white);
  min-height: 100vh;
  overflow-x: hidden;
}

/* NOISE TEXTURE OVERLAY */
body::before {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
  pointer-events: none;
  opacity: 0.6;
}

/* SCANLINES */
body::after {
  content: '';
  position: fixed; inset: 0; z-index: 0;
  background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.07) 2px, rgba(0,0,0,0.07) 4px);
  pointer-events: none;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
header {
  position: sticky; top: 0; z-index: 100;
  background: var(--black);
  border-bottom: 3px solid var(--red);
  box-shadow: 0 4px 30px var(--red-glow);
}

.header-flame {
  background: linear-gradient(90deg, var(--red) 0%, #ff6600 50%, var(--red) 100%);
  height: 3px;
  animation: flamePulse 2s ease-in-out infinite;
}
@keyframes flamePulse {
  0%,100% { opacity: 1; }
  50% { opacity: 0.6; }
}

.header-main {
  padding: 12px 14px 0;
}

.header-top {
  display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;
}

.shop-name {
  font-family: 'Metal Mania', cursive;
  font-size: 22px; letter-spacing: 2px;
  color: var(--white);
  text-shadow: 0 0 20px var(--red), 0 0 40px rgba(204,0,0,0.4);
  line-height: 1;
}

.header-right { display: flex; align-items: center; gap: 8px; }

.cart-btn {
  position: relative;
  background: var(--black3); border: 2px solid var(--red);
  color: var(--white); width: 40px; height: 40px;
  font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all .2s;
  clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
}
.cart-btn:hover { background: var(--red); box-shadow: 0 0 20px var(--red-glow); }
.cart-count {
  position: absolute; top: -6px; right: -6px;
  background: var(--red); color: var(--white);
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: 11px; width: 18px; height: 18px;
  display: flex; align-items: center; justify-content: center;
  border: 1px solid var(--black);
}

.admin-btn {
  background: var(--black3); border: 2px solid var(--grey);
  color: var(--white2); font-family: 'Barlow Condensed', sans-serif;
  font-weight: 700; font-size: 12px; letter-spacing: 1px;
  padding: 8px 12px; cursor: pointer; transition: all .2s;
  text-transform: uppercase;
  clip-path: polygon(6px 0%, 100% 0%, calc(100% - 6px) 100%, 0% 100%);
}
.admin-btn:hover { border-color: var(--red); color: var(--red); box-shadow: 0 0 12px var(--red-glow); }

/* SEARCH */
.search-wrap { position: relative; margin-bottom: 10px; }
.search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--red); }
#searchInput {
  width: 100%; background: var(--black3);
  border: 1px solid var(--grey); border-left: 3px solid var(--red);
  color: var(--white); font-family: 'Oswald', sans-serif; font-size: 15px; font-weight: 400;
  letter-spacing: 1px; text-transform: uppercase;
  padding: 10px 12px 10px 38px; outline: none; transition: all .2s;
}
#searchInput:focus { border-color: var(--red); box-shadow: 0 0 15px var(--red-glow); }
#searchInput::placeholder { color: var(--grey); font-size: 13px; }

/* FILTERS */
.filters {
  display: flex; gap: 6px; overflow-x: auto; padding-bottom: 12px; scrollbar-width: none;
}
.filters::-webkit-scrollbar { display: none; }
.filter-btn {
  flex-shrink: 0; background: var(--black3);
  border: 1px solid var(--grey); border-bottom: 2px solid transparent;
  color: var(--white2); font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700;
  padding: 5px 14px; cursor: pointer; transition: all .2s;
  letter-spacing: 1px; text-transform: uppercase;
  white-space: nowrap;
}
.filter-btn.active {
  background: var(--red); border-color: var(--red);
  color: var(--white); box-shadow: 0 0 12px var(--red-glow);
}
.filter-btn:hover:not(.active) { border-bottom-color: var(--red); color: var(--white); }

/* ‚îÄ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ‚îÄ */
main { padding: 6px 8px; position: relative; z-index: 1; }

.results-info {
  font-family: 'Barlow Condensed', sans-serif; font-size: 11px;
  color: var(--grey); letter-spacing: 2px; text-transform: uppercase;
  margin-bottom: 4px;
}

.grid {
  display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;
}

/* ‚îÄ‚îÄ‚îÄ CARD ‚îÄ‚îÄ‚îÄ */
.card {
  background: var(--black2);
  border: 1px solid #333;
  border-top: 2px solid var(--red);
  cursor: pointer;
  transition: all .2s;
  animation: riseUp .35s ease both;
  position: relative; overflow: hidden;
}
.card::before {
  content: ''; position: absolute; inset: 0;
  background: linear-gradient(135deg, transparent 60%, rgba(204,0,0,0.06) 100%);
  pointer-events: none;
}
.card:hover {
  border-color: var(--red);
  box-shadow: 0 0 12px var(--red-glow);
  transform: translateY(-2px);
}
@keyframes riseUp { from { opacity:0; transform:translateY(10px) } to { opacity:1; transform:none } }

.card-img {
  width: 100%; aspect-ratio: 1/1;
  background: var(--black3);
  display: flex; align-items: center; justify-content: center;
  font-size: 18px; overflow: hidden; position: relative;
}
.card-img img { width:100%; height:100%; object-fit:cover; }
.card-img::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0;
  height: 25%; background: linear-gradient(transparent, var(--black2));
  pointer-events: none;
}

.card-badge {
  position: absolute; top: 4px; left: 0;
  background: var(--red); color: var(--white);
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: 9px; letter-spacing: 1px;
  padding: 1px 7px 1px 5px;
  clip-path: polygon(0 0, 100% 0, calc(100% - 4px) 100%, 0 100%);
}

.card-body { padding: 5px 6px 0; }
.card-cat {
  font-family: 'Barlow Condensed', sans-serif; font-size: 8px;
  color: var(--red); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 1px;
}
.card-name {
  font-family: 'Oswald', sans-serif; font-size: 11px; font-weight: 600;
  text-transform: uppercase; letter-spacing: .2px; line-height: 1.15; margin-bottom: 3px;
  color: var(--white);
  display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;
}
.price-row { display: flex; align-items: baseline; gap: 3px; margin-bottom: 4px; }
.card-price {
  font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 900;
  color: var(--white); letter-spacing: .3px;
}
.card-old {
  font-size: 9px; color: var(--grey); text-decoration: line-through;
}

.card-add-btn {
  width: 100%; background: transparent; border: 1px solid var(--red);
  color: var(--red); font-family: 'Barlow Condensed', sans-serif;
  font-weight: 900; font-size: 10px; letter-spacing: 1px; text-transform: uppercase;
  padding: 4px; cursor: pointer; transition: all .2s;
}
.card-add-btn:hover { background: var(--red); color: var(--white); box-shadow: 0 0 8px var(--red-glow); }
.card-add-btn.in-cart { background: var(--red); color: var(--white); }

.empty {
  grid-column: 1/-1; text-align: center; padding: 60px 20px; color: var(--grey);
}
.empty-icon { font-size: 52px; display: block; margin-bottom: 12px; opacity: .5; }
.empty h3 { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 3px; font-size: 18px; }

/* ‚îÄ‚îÄ‚îÄ PRODUCT MODAL ‚îÄ‚îÄ‚îÄ */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.85);
  z-index: 200; display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
.overlay.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--black2); border-top: 3px solid var(--red);
  box-shadow: 0 -10px 60px var(--red-glow);
  width: 100%; max-width: 480px; max-height: 88vh; overflow-y: auto;
  transform: translateY(100%); transition: transform .3s cubic-bezier(.2,.8,.3,1);
  position: relative;
}
.overlay.open .modal { transform: none; }

.modal-img {
  width: 100%; aspect-ratio: 1/1;
  background: var(--black3); overflow: hidden;
  display: flex; align-items: center; justify-content: center;
  font-size: 80px; position: relative;
}
.modal-img img { width:100%; height:100%; object-fit:cover; }
.modal-img-overlay {
  position: absolute; bottom: 0; left: 0; right: 0; height: 50%;
  background: linear-gradient(transparent, var(--black2));
}

.modal-close {
  position: absolute; top: 12px; right: 12px; z-index: 10;
  background: rgba(0,0,0,.8); border: 1px solid var(--grey);
  color: var(--white); width: 32px; height: 32px;
  font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: border-color .2s;
}
.modal-close:hover { border-color: var(--red); color: var(--red); }

.modal-body { padding: 20px; }
.modal-cat { font-family: 'Barlow Condensed', sans-serif; font-size: 11px; color: var(--red); letter-spacing: 3px; text-transform: uppercase; margin-bottom: 6px; }
.modal-name { font-family: 'Metal Mania', cursive; font-size: 26px; letter-spacing: 1px; color: var(--white); margin-bottom: 10px; line-height: 1.2; text-shadow: 0 0 15px rgba(204,0,0,0.3); }
.modal-desc { font-size: 14px; color: var(--white2); line-height: 1.7; margin-bottom: 18px; font-weight: 300; }
.modal-price-row { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.modal-price { font-family: 'Barlow Condensed', sans-serif; font-size: 30px; font-weight: 900; color: var(--white); }
.modal-old { font-size: 18px; color: var(--grey); text-decoration: line-through; }

.modal-actions { display: flex; gap: 10px; }
.modal-cart-btn {
  flex: 1; background: var(--red); color: var(--white); border: none;
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: 16px; letter-spacing: 2px; text-transform: uppercase;
  padding: 14px; cursor: pointer; transition: all .2s;
  box-shadow: 0 0 20px var(--red-glow);
}
.modal-cart-btn:hover { background: var(--red2); }
.modal-cart-btn.in-cart { background: var(--black3); border: 2px solid var(--red); color: var(--red); box-shadow: none; }

/* ‚îÄ‚îÄ‚îÄ CART ‚îÄ‚îÄ‚îÄ */
.cart-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.85); z-index: 300;
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
.cart-overlay.open { opacity: 1; pointer-events: all; }
.cart-panel {
  background: var(--black2); border-top: 3px solid var(--red);
  box-shadow: 0 -10px 60px var(--red-glow);
  width: 100%; max-width: 480px; max-height: 85vh;
  display: flex; flex-direction: column;
  transform: translateY(100%); transition: transform .3s cubic-bezier(.2,.8,.3,1);
}
.cart-overlay.open .cart-panel { transform: none; }

.cart-header {
  padding: 16px 16px 12px;
  border-bottom: 1px solid #2a2a2a;
  display: flex; align-items: center; justify-content: space-between;
  flex-shrink: 0;
}
.cart-title { font-family: 'Metal Mania', cursive; font-size: 22px; letter-spacing: 2px; text-shadow: 0 0 12px var(--red-glow); }
.cart-close {
  background: none; border: 1px solid var(--grey); color: var(--white2);
  width: 32px; height: 32px; font-size: 16px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all .2s;
}
.cart-close:hover { border-color: var(--red); color: var(--red); }

.cart-items { flex: 1; overflow-y: auto; padding: 12px 16px; }
.cart-empty {
  text-align: center; padding: 40px 20px; color: var(--grey);
}
.cart-empty-icon { font-size: 48px; display: block; margin-bottom: 12px; opacity: .4; }
.cart-empty p { font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 2px; font-size: 14px; }

.cart-item {
  display: flex; gap: 12px; align-items: center;
  padding: 10px 0; border-bottom: 1px solid #1e1e1e;
}
.cart-item-img {
  width: 52px; height: 52px; flex-shrink: 0;
  background: var(--black3); border: 1px solid #333;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; overflow: hidden;
}
.cart-item-img img { width:100%; height:100%; object-fit:cover; }
.cart-item-info { flex: 1; min-width: 0; }
.cart-item-name { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.cart-item-price { font-family: 'Barlow Condensed', sans-serif; font-size: 14px; color: var(--white2); margin-top: 2px; }

.cart-item-qty { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
.qty-btn {
  background: var(--black3); border: 1px solid var(--grey);
  color: var(--white); width: 26px; height: 26px;
  font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all .2s;
}
.qty-btn:hover { border-color: var(--red); color: var(--red); }
.qty-num { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 700; min-width: 20px; text-align: center; }

.cart-footer { padding: 14px 16px; border-top: 1px solid #2a2a2a; flex-shrink: 0; }
.cart-total-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
.cart-total-label { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; letter-spacing: 2px; text-transform: uppercase; color: var(--white2); }
.cart-total-price { font-family: 'Barlow Condensed', sans-serif; font-size: 28px; font-weight: 900; color: var(--white); }

.order-btn {
  width: 100%; background: var(--red); color: var(--white); border: none;
  font-family: 'Metal Mania', cursive; font-size: 20px; letter-spacing: 3px;
  padding: 16px; cursor: pointer; transition: all .2s;
  box-shadow: 0 0 30px var(--red-glow);
  text-transform: uppercase;
}
.order-btn:hover { background: var(--red2); box-shadow: 0 0 40px rgba(255,26,26,0.5); }
.order-btn:disabled { background: var(--grey); box-shadow: none; cursor: not-allowed; }

/* ‚îÄ‚îÄ‚îÄ PIN ‚îÄ‚îÄ‚îÄ */
.pin-overlay {
  position: fixed; inset: 0; background: var(--black); z-index: 400;
  display: flex; align-items: center; justify-content: center; flex-direction: column;
  gap: 20px; padding: 32px;
}
.pin-skull { font-size: 60px; animation: pulse 2s ease-in-out infinite; }
@keyframes pulse { 0%,100% { transform:scale(1); } 50% { transform:scale(1.05); } }
.pin-title { font-family: 'Metal Mania', cursive; font-size: 28px; letter-spacing: 4px; text-shadow: 0 0 20px var(--red); text-align: center; }
.pin-sub { font-family: 'Barlow Condensed', sans-serif; font-size: 13px; letter-spacing: 2px; color: var(--grey); text-transform: uppercase; }
.pin-input {
  width: 100%; max-width: 280px; background: var(--black3);
  border: 1px solid var(--grey); border-bottom: 3px solid var(--red);
  color: var(--white); font-family: 'Barlow Condensed', sans-serif; font-size: 28px; font-weight: 700;
  padding: 14px; outline: none; text-align: center; letter-spacing: 8px; transition: all .2s;
}
.pin-input:focus { border-color: var(--red); box-shadow: 0 0 20px var(--red-glow); }
.pin-submit {
  width: 100%; max-width: 280px;
  background: var(--red); color: var(--white); border: none;
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: 18px; letter-spacing: 3px; text-transform: uppercase;
  padding: 14px; cursor: pointer; transition: all .2s;
  box-shadow: 0 0 20px var(--red-glow);
}
.pin-submit:hover { background: var(--red2); }
.pin-error { color: var(--red3); font-family: 'Barlow Condensed', sans-serif; font-size: 13px; letter-spacing: 1px; text-transform: uppercase; display: none; }
.pin-cancel { background:none;border:none;color:var(--grey);cursor:pointer;font-family:'Oswald',sans-serif;font-size:13px;letter-spacing:1px;text-transform:uppercase;margin-top:-8px; }

/* ‚îÄ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ */
.admin-overlay {
  position: fixed; inset: 0; background: var(--black); z-index: 300;
  overflow-y: auto; display: none;
}
.admin-overlay.open { display: block; }

.admin-header {
  background: var(--black2); border-bottom: 3px solid var(--red);
  box-shadow: 0 4px 30px var(--red-glow);
  padding: 14px 16px; display: flex; align-items: center; gap: 14px;
  position: sticky; top: 0; z-index: 10;
}
.back-btn {
  background: var(--black3); border: 1px solid var(--grey);
  color: var(--white); width: 36px; height: 36px;
  font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all .2s;
}
.back-btn:hover { border-color: var(--red); color: var(--red); }
.admin-title { font-family: 'Metal Mania', cursive; font-size: 18px; letter-spacing: 2px; text-shadow: 0 0 12px var(--red-glow); }

.admin-body { padding: 16px; }
.admin-section { margin-bottom: 28px; }
.section-title {
  font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700;
  color: var(--red); letter-spacing: 3px; text-transform: uppercase;
  margin-bottom: 12px; padding-bottom: 8px;
  border-bottom: 1px solid #222;
  display: flex; align-items: center; gap: 8px;
}
.section-title::before { content: '‚ñ∂'; font-size: 8px; }

.form-group { margin-bottom: 12px; }
.form-group label { display: block; font-family: 'Barlow Condensed', sans-serif; font-size: 11px; color: var(--grey); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
.form-group input, .form-group textarea, .form-group select {
  width: 100%; background: var(--black3);
  border: 1px solid #333; border-left: 3px solid var(--red);
  color: var(--white); font-family: 'Oswald', sans-serif; font-size: 14px;
  padding: 10px 12px; outline: none; transition: all .2s;
}
.form-group input:focus, .form-group textarea:focus, .form-group select:focus {
  border-color: var(--red); box-shadow: 0 0 12px var(--red-glow);
}
.form-group textarea { resize: vertical; min-height: 80px; }
.form-group select option { background: var(--black3); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }



.btn-primary {
  width: 100%; background: var(--red); color: var(--white); border: none;
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900;
  font-size: 16px; letter-spacing: 3px; text-transform: uppercase;
  padding: 13px; cursor: pointer; transition: all .2s; margin-bottom: 8px;
  box-shadow: 0 0 20px var(--red-glow);
}
.btn-primary:hover { background: var(--red2); }

.btn-cancel {
  width: 100%; background: transparent; border: 1px solid var(--grey);
  color: var(--grey); font-family: 'Barlow Condensed', sans-serif;
  font-weight: 700; font-size: 14px; letter-spacing: 2px; text-transform: uppercase;
  padding: 10px; cursor: pointer; transition: all .2s; display: none;
}
.btn-cancel.visible { display: block; }
.btn-cancel:hover { border-color: var(--white2); color: var(--white2); }

.settings-list { display: flex; flex-direction: column; gap: 8px; }
.setting-row {
  background: var(--black3); border: 1px solid #2a2a2a; border-left: 3px solid var(--red);
  padding: 12px; display: flex; align-items: center; justify-content: space-between; gap: 12px;
}
.setting-label { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; }
.setting-sub { font-size: 11px; color: var(--grey); letter-spacing: .5px; margin-top: 2px; }
.setting-row input {
  background: var(--black); border: 1px solid #333; border-bottom: 2px solid var(--red);
  color: var(--white); font-family: 'Oswald', sans-serif; font-size: 14px;
  padding: 6px 10px; outline: none; width: 150px; transition: all .2s;
}

/* CATEGORIES */
.cat-chips { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px; }
.cat-chip {
  background: var(--black3); border: 1px solid #333;
  font-family: 'Barlow Condensed', sans-serif; font-size: 12px; letter-spacing: 1px; text-transform: uppercase;
  padding: 4px 10px; display: flex; align-items: center; gap: 6px; color: var(--white2);
}
.cat-chip button { background:none;border:none;color:var(--red);cursor:pointer;font-size:16px;line-height:1;padding:0; }
.add-cat-row { display: flex; gap: 6px; }
.add-cat-row input {
  flex: 1; background: var(--black3); border: 1px solid #333; border-bottom: 2px solid var(--red);
  color: var(--white); font-family: 'Oswald', sans-serif; font-size: 14px;
  padding: 8px 12px; outline: none;
}
.add-cat-row button {
  background: var(--red); color: var(--white); border: none;
  font-family: 'Barlow Condensed', sans-serif; font-weight: 900; font-size: 13px; letter-spacing: 1px;
  padding: 8px 16px; cursor: pointer; text-transform: uppercase; white-space: nowrap;
  transition: background .2s;
}
.add-cat-row button:hover { background: var(--red2); }

.product-list { display: flex; flex-direction: column; gap: 8px; }
.product-item {
  background: var(--black3); border: 1px solid #2a2a2a; border-left: 3px solid #333;
  padding: 10px 12px; display: flex; align-items: center; gap: 10px;
  transition: border-color .2s, opacity .2s;
  cursor: grab; user-select: none;
}
.product-item:active { cursor: grabbing; }
.product-item:hover { border-left-color: var(--red); }
.product-item.hidden-product { opacity: .45; border-left-color: var(--grey) !important; }
.product-item.drag-over { border: 2px dashed var(--red); box-shadow: 0 0 12px var(--red-glow); }
.product-item.dragging { opacity: .3; }
.drag-handle {
  color: var(--grey); font-size: 16px; flex-shrink: 0; cursor: grab; padding: 0 2px;
  line-height: 1;
}
.product-item-thumb {
  width: 44px; height: 44px; flex-shrink: 0;
  background: var(--black2); display: flex; align-items: center; justify-content: center;
  font-size: 22px; overflow: hidden; border: 1px solid #333;
}
.product-item-thumb img { width:100%; height:100%; object-fit:cover; }
.product-item-info { flex: 1; min-width: 0; }
.product-item-name { font-size: 13px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.product-item-meta { font-size: 11px; color: var(--grey); letter-spacing: .5px; margin-top: 2px; }
.product-item-actions { display: flex; gap: 6px; flex-shrink: 0; }
.btn-edit, .btn-del, .btn-hide {
  background: none; border: 1px solid #333;
  font-size: 13px; padding: 5px 7px; cursor: pointer; transition: all .2s;
}
.btn-edit { color: var(--white2); }
.btn-edit:hover { border-color: var(--white2); background: var(--black2); }
.btn-del { color: var(--red); }
.btn-del:hover { background: var(--red); color: var(--white); border-color: var(--red); }
.btn-hide { color: var(--grey); }
.btn-hide:hover { border-color: #ff9900; color: #ff9900; }
.btn-hide.is-hidden { color: #34d399; border-color: #34d399; }
.btn-hide.is-hidden:hover { background: #34d399; color: var(--black); }

/* TOAST */
.toast {
  position: fixed; bottom: 28px; left: 50%; z-index: 999;
  transform: translateX(-50%) translateY(80px);
  background: var(--red); color: var(--white);
  font-family: 'Barlow Condensed', sans-serif; font-weight: 700; font-size: 14px;
  letter-spacing: 2px; text-transform: uppercase;
  padding: 10px 24px; border-top: 2px solid var(--red2);
  box-shadow: 0 0 30px var(--red-glow);
  transition: transform .3s cubic-bezier(.2,.8,.3,1);
  white-space: nowrap;
}
.toast.ok { background: #1a4a1a; border-top-color: #34d399; box-shadow: 0 0 20px rgba(52,211,153,0.3); }
.toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê CATALOG ‚ïê‚ïê‚ïê -->
<header>
  <div class="header-flame"></div>
  <div class="header-main">
    <div class="header-top">
      <div class="shop-name" id="shopNameDisplay">üî• –ú–ê–ì–ê–ó–ò–ù</div>
      <div class="header-right">
        <button class="cart-btn" onclick="openCart()">
          üõí
          <span class="cart-count" id="cartCount" style="display:none">0</span>
        </button>
        <button class="admin-btn" onclick="openPinOverlay()">‚öô ADMIN</button>
      </div>
    </div>
    <div class="search-wrap">
      <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫..." oninput="renderCatalog()">
    </div>
    <div class="filters" id="filters"></div>
  </div>
</header>

<main>
  <div class="results-info" id="resultsInfo"></div>
  <div class="grid" id="grid"></div>
</main>

<!-- ‚ïê‚ïê‚ïê PRODUCT MODAL ‚ïê‚ïê‚ïê -->
<div class="overlay" id="productOverlay" onclick="closeProductModal(event)">
  <div class="modal" id="productModal">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-img" id="modalImg">
      <div class="modal-img-overlay"></div>
    </div>
    <div class="modal-body">
      <div class="modal-cat" id="modalCat"></div>
      <div class="modal-name" id="modalName"></div>
      <div class="modal-desc" id="modalDesc"></div>
      <div class="modal-price-row">
        <span class="modal-price" id="modalPrice"></span>
        <span class="modal-old" id="modalOld"></span>
      </div>
      <div class="modal-actions">
        <button class="modal-cart-btn" id="modalCartBtn" onclick="toggleCartFromModal()">+ –í –ö–û–†–ó–ò–ù–£</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CART ‚ïê‚ïê‚ïê -->
<div class="cart-overlay" id="cartOverlay" onclick="closeCartModal(event)">
  <div class="cart-panel">
    <div class="cart-header">
      <div class="cart-title">üõí –ö–û–†–ó–ò–ù–ê</div>
      <button class="cart-close" onclick="closeCart()">‚úï</button>
    </div>
    <div class="cart-items" id="cartItems"></div>
    <div class="cart-footer">
      <div class="cart-total-row">
        <span class="cart-total-label">–ò—Ç–æ–≥–æ</span>
        <span class="cart-total-price" id="cartTotal">0 ‚ÇΩ</span>
      </div>
      <button class="order-btn" id="orderBtn" onclick="sendOrder()">‚ö° –û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PIN ‚ïê‚ïê‚ïê -->
<div class="pin-overlay" id="pinOverlay" style="display:none">
  <div class="pin-skull">üíÄ</div>
  <div class="pin-title">ADMIN ZONE</div>
  <div class="pin-sub">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</div>
  <input type="password" class="pin-input" id="pinInput" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')checkPin()">
  <div class="pin-error" id="pinError">‚õî –ù–ï–í–ï–†–ù–´–ô –ü–ê–†–û–õ–¨</div>
  <button class="pin-submit" onclick="checkPin()">–í–û–ô–¢–ò</button>
  <button class="pin-cancel" onclick="document.getElementById('pinOverlay').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
</div>

<!-- ‚ïê‚ïê‚ïê ADMIN ‚ïê‚ïê‚ïê -->
<div class="admin-overlay" id="adminOverlay">
  <div class="admin-header">
    <button class="back-btn" onclick="closeAdmin()">‚Üê</button>
    <div class="admin-title">‚öô –£–ü–†–ê–í–õ–ï–ù–ò–ï</div>
  </div>
  <div class="admin-body">

    <div id="storagePanel" style="background:var(--black3);border:1px solid #2a2a2a;border-left:3px solid var(--red);padding:12px 14px;margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:2px;text-transform:uppercase;color:var(--white2);">// –ü–ê–ú–Ø–¢–¨ –ë–†–ê–£–ó–ï–†–ê //</span>
        <span id="storageText" style="font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;color:var(--white);"></span>
      </div>
      <div style="background:var(--black);height:8px;width:100%;border:1px solid #333;overflow:hidden;">
        <div id="storageBar" style="height:100%;width:0%;background:var(--red);transition:width .5s ease;box-shadow:0 0 10px var(--red-glow);"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:5px;">
        <span id="storageHint" style="font-family:'Barlow Condensed',sans-serif;font-size:10px;letter-spacing:1px;color:var(--grey);"></span>
        <span style="font-family:'Barlow Condensed',sans-serif;font-size:10px;letter-spacing:1px;color:var(--grey);">MAX ~5 –ú–ë</span>
      </div>
    </div>

    <div class="admin-section">
      <div class="section-title">–ù–ê–°–¢–†–û–ô–ö–ò –ú–ê–ì–ê–ó–ò–ù–ê</div>
      <div class="settings-list">
        <div class="setting-row">
          <div><div class="setting-label">–ù–∞–∑–≤–∞–Ω–∏–µ</div></div>
          <input type="text" id="settingName" placeholder="–ú–æ–π –º–∞–≥–∞–∑–∏–Ω">
        </div>
        <div class="setting-row">
          <div><div class="setting-label">–ü–∞—Ä–æ–ª—å</div><div class="setting-sub">–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1234</div></div>
          <input type="password" id="settingPass" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
        </div>
        <div class="setting-row">
          <div><div class="setting-label">Telegram</div><div class="setting-sub">–î–ª—è –ø—Ä–∏—ë–º–∞ –∑–∞–∫–∞–∑–æ–≤</div></div>
          <input type="text" id="settingUsername" placeholder="@username">
        </div>
      </div>
      <br>
      <div style="background:var(--black);border:1px solid #333;border-left:3px solid #ff9900;padding:12px;margin-bottom:12px;">
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:2px;color:#ff9900;text-transform:uppercase;margin-bottom:8px;">‚òÅ –û–ë–õ–ê–ß–ù–ê–Ø –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø (JSONBin.io)</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:11px;color:var(--grey);line-height:1.6;margin-bottom:10px;">
          –¢–æ–≤–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –Ω–∞ –≤—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. <span style="color:#ff9900">‚ö† –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è</span> ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ URL-—Å—Å—ã–ª–∫–∏ –Ω–∞ —Ñ–æ—Ç–æ –≤–º–µ—Å—Ç–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤.
        </div>
        <div id="cloudStatus" style="font-family:'Barlow Condensed',sans-serif;font-size:11px;letter-spacing:1px;padding:6px 10px;margin-bottom:10px;border:1px solid #333;"></div>
        <div class="form-group" style="margin-bottom:8px;">
          <label>API KEY (X-Master-Key)</label>
          <input type="text" id="settingBinKey" placeholder="$2a$10$...">
        </div>
        <div class="form-group" style="margin-bottom:0;">
          <label>BIN ID</label>
          <input type="text" id="settingBinId" placeholder="64f3a...">
        </div>
      </div>
      <button class="btn-primary" onclick="saveSettings()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>

    <div class="admin-section">
      <div class="section-title">–ü–ï–†–ï–ù–û–° –î–ê–ù–ù–´–•</div>
      <div style="font-family:'Barlow Condensed',sans-serif;font-size:12px;color:var(--grey);letter-spacing:.5px;line-height:1.5;margin-bottom:12px;">
        –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ß—Ç–æ–±—ã –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç–æ–≤–∞—Ä—ã –≤ Telegram ‚Äî —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ, –∑–∞—Ç–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –µ–≥–æ –æ—Ç–∫—Ä—ã–≤ –∫–∞—Ç–∞–ª–æ–≥ –≤ Telegram.
      </div>
      <button class="btn-primary" id="syncBtn" onclick="syncCloud()" style="background:var(--black3);border:2px solid #ff9900;color:#ff9900;box-shadow:none;margin-bottom:8px;">‚òÅ –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–¢–¨ –° –û–ë–õ–ê–ö–û–ú</button>
      <button class="btn-primary" onclick="exportData()" style="background:var(--black3);border:2px solid var(--red);color:var(--red);box-shadow:none;margin-bottom:8px;">üì§ –≠–ö–°–ü–û–†–¢ ‚Äî —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª —Å —Ç–æ–≤–∞—Ä–∞–º–∏</button>
      <div style="position:relative;">
        <button class="btn-primary" onclick="document.getElementById('importFile').click()" style="background:var(--black3);border:2px solid var(--red);color:var(--red);box-shadow:none;">üì• –ò–ú–ü–û–†–¢ ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª —Å —Ç–æ–≤–∞—Ä–∞–º–∏</button>
        <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display:none;">
      </div>
    </div>

    <div class="admin-section">
      <div class="section-title">–ö–ê–¢–ï–ì–û–†–ò–ò</div>
      <div class="cat-chips" id="catChips"></div>
      <div class="add-cat-row">
        <input type="text" id="newCatInput" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è...">
        <button onclick="addCategory()">+ –î–û–ë–ê–í–ò–¢–¨</button>
      </div>
    </div>

    <div class="admin-section">
      <div class="section-title" id="formTitle">–î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†</div>
      <input type="hidden" id="editingId">

      <div class="form-group">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ *</label>
        <input type="text" id="fName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
      </div>
      <div class="form-group">
        <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
        <textarea id="fDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea>
      </div>
      <div class="form-group">
        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
        <select id="fCat"></select>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>–¶–µ–Ω–∞ *</label>
          <input type="number" id="fPrice" placeholder="1000">
        </div>
        <div class="form-group">
          <label>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</label>
          <input type="number" id="fOldPrice" placeholder="‚Äî">
        </div>
      </div>
      <div class="form-group">
        <label>–≠–º–æ–¥–∑–∏ (–µ—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ)</label>
        <input type="text" id="fEmoji" placeholder="üî•">
      </div>

      <div class="form-group">
        <label>URL —Ñ–æ—Ç–æ <span style="color:#ff9900;font-size:10px">‚òÖ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ –æ–±–ª–∞–∫–æ</span></label>
        <div style="display:flex;gap:6px;align-items:center;">
          <input type="text" id="fImgUrl" placeholder="https://i.ibb.co/..." oninput="previewUrl()" style="flex:1;">
          <button type="button" onclick="applyUrl()" style="background:var(--red);border:none;color:#fff;font-family:'Barlow Condensed',sans-serif;font-weight:900;font-size:12px;letter-spacing:1px;padding:10px 12px;cursor:pointer;white-space:nowrap;">–ü–†–ò–ú–ï–ù–ò–¢–¨</button>
        </div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:10px;color:var(--grey);margin-top:4px;letter-spacing:.5px;">
          –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –Ω–∞ <a href="https://imgbb.com" target="_blank" style="color:#ff9900;">imgbb.com</a> ‚Üí —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ Direct Link ‚Üí –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞
        </div>
        <img id="urlPreview" src="" alt="" style="display:none;width:100%;max-height:120px;object-fit:contain;margin-top:8px;border:1px solid #333;background:var(--black3);">
      </div>



      <button class="btn-primary" onclick="saveProduct()">‚úÖ –°–û–•–†–ê–ù–ò–¢–¨ –¢–û–í–ê–†</button>
      <button class="btn-cancel" id="cancelEditBtn" onclick="cancelEdit()">–û–¢–ú–ï–ù–ê</button>
    </div>

    <div class="admin-section">
      <div class="section-title">–¢–û–í–ê–†–´ –í –ö–ê–¢–ê–õ–û–ì–ï</div>
      <div class="product-list" id="adminProductList"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ STORAGE ‚îÄ‚îÄ‚îÄ
const S = {
  get(k, d) { try { return JSON.parse(localStorage.getItem(k)) ?? d; } catch { return d; } },
  set(k, v) { localStorage.setItem(k, JSON.stringify(v)); }
};

// ‚îÄ‚îÄ –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–ò –î–ê–ù–ù–´–ï JSONBIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_BIN_KEY = '$2a$10$189mM.pyFDz/D6cMj9ZcQ.WHgbluE/ZZiuUXRnHcIgkTsLYRaL.iK'; // —Å—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—å API Key —Å jsonbin.io
const DEFAULT_BIN_ID  = '6996e950d0ea881f40c68401'; // —Å—é–¥–∞ –≤—Å—Ç–∞–≤–∏—Ç—å BIN ID
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let products  = S.get('products_v2', [
  { id:1, name:'–ü–†–ò–ú–ï–† –¢–û–í–ê–† I',   desc:'–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞. –ò–∑–º–µ–Ω–∏—Ç–µ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.', category:'–û—Å–Ω–æ–≤–Ω–æ–µ', price:1500, oldPrice:2000, emoji:'üî•', img:'' },
  { id:2, name:'–ü–†–ò–ú–ï–† –¢–û–í–ê–† II',  desc:'–ï—â—ë –æ–¥–∏–Ω –ø—Ä–∏–º–µ—Ä —Ç–æ–≤–∞—Ä–∞.',                  category:'–û—Å–Ω–æ–≤–Ω–æ–µ', price:990,  oldPrice:'',   emoji:'‚ö°', img:'' },
  { id:3, name:'–ü–†–ò–ú–ï–† –¢–û–í–ê–† III', desc:'–¢–æ–≤–∞—Ä —Å–æ —Å–∫–∏–¥–∫–æ–π.',                         category:'–ê–∫—Ü–∏–∏',    price:499,  oldPrice:1500, emoji:'üíÄ', img:'' },
]);
let categories = S.get('categories_v2', ['–í—Å–µ','–û—Å–Ω–æ–≤–Ω–æ–µ','–ê–∫—Ü–∏–∏']);
let settings   = S.get('settings_v2',   { name:'–ú–ê–ì–ê–ó–ò–ù', pass:'1234', username:'' });
let cart       = {}; // { productId: qty }
let activeCategory = '–í—Å–µ';
let currentProduct = null;

function persist(cloud = true) {
  try {
    S.set("products_v2", products);
    S.set("categories_v2", categories);
    S.set("settings_v2", settings);
  } catch(e) {
    if (e.name === "QuotaExceededError" || e.code === 22) {
      showToast("‚ö† –ú–∞–ª–æ –º–µ—Å—Ç–∞! –£–¥–∞–ª–∏—Ç–µ —á–∞—Å—Ç—å —Ñ–æ—Ç–æ –∏–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤");
    }
  }
  if (cloud && hasCloud()) cloudSave();
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function fmt(n) { return Number(n).toLocaleString('ru-RU') + ' ‚ÇΩ'; }
function cartTotal() {
  return Object.entries(cart).reduce((sum,[id,qty]) => {
    const p = products.find(x => x.id === +id);
    return p ? sum + p.price * qty : sum;
  }, 0);
}
function cartCount() { return Object.values(cart).reduce((a,b) => a+b, 0); }
function inCart(id) { return (cart[id] || 0) > 0; }

function updateCartBadge() {
  const c = cartCount();
  const el = document.getElementById('cartCount');
  el.style.display = c ? 'flex' : 'none';
  el.textContent = c > 99 ? '99+' : c;
}

// ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ
function showToast(msg, ok=false) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast' + (ok?' ok':'') + ' show';
  setTimeout(() => t.classList.remove('show'), 2500);
}

// ‚îÄ‚îÄ‚îÄ CATALOG RENDER ‚îÄ‚îÄ‚îÄ
function renderFilters() {
  document.getElementById('filters').innerHTML = categories.map(c =>
    `<button class="filter-btn${activeCategory===c?' active':''}" onclick="setCategory('${c}')">${c}</button>`
  ).join('');
}

function setCategory(c) { activeCategory = c; renderCatalog(); }

function getFiltered() {
  const q = (document.getElementById('searchInput')?.value||'').toLowerCase().trim();
  return products.filter(p => {
    if (p.hidden) return false;
    const mc = activeCategory === '–í—Å–µ' || p.category === activeCategory;
    const mq = !q || p.name.toLowerCase().includes(q) || (p.desc||'').toLowerCase().includes(q);
    return mc && mq;
  });
}

function renderCatalog() {
  renderFilters();
  document.getElementById('shopNameDisplay').textContent = settings.name || '–ú–ê–ì–ê–ó–ò–ù';
  const filtered = getFiltered();
  document.getElementById('resultsInfo').textContent =
    `// ${filtered.length} –ü–û–ó–ò–¶–ò–ô //`;

  const grid = document.getElementById('grid');
  if (!filtered.length) {
    grid.innerHTML = `<div class="empty"><span class="empty-icon">üîç</span><h3>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3></div>`;
    return;
  }
  grid.innerHTML = filtered.map((p,i) => cardHTML(p,i)).join('');
}

function cardHTML(p, i) {
  const sale = p.oldPrice ? Math.round((1 - p.price/p.oldPrice)*100) : 0;
  const thumb = p.img
    ? `<img src="${p.img}" alt="" loading="lazy">`
    : (p.emoji || 'üì¶');
  const ic = inCart(p.id);
  return `<div class="card" style="animation-delay:${i*0.04}s">
    <div class="card-img" onclick="openProduct(${p.id})">${thumb}</div>
    ${sale ? `<div class="card-badge">-${sale}%</div>` : ''}
    <div class="card-body" onclick="openProduct(${p.id})">
      <div class="card-cat">${p.category}</div>
      <div class="card-name">${p.name}</div>
      <div class="price-row">
        <span class="card-price">${fmt(p.price)}</span>
        ${p.oldPrice ? `<span class="card-old">${fmt(p.oldPrice)}</span>` : ''}
      </div>
    </div>
    <button class="card-add-btn${ic?' in-cart':''}" onclick="toggleCart(${p.id},this)">
      ${ic ? '‚úì –í –ö–û–†–ó–ò–ù–ï' : '+ –í –ö–û–†–ó–ò–ù–£'}
    </button>
  </div>`;
}

// ‚îÄ‚îÄ‚îÄ CART TOGGLE ‚îÄ‚îÄ‚îÄ
function toggleCart(id, btn) {
  if (inCart(id)) {
    delete cart[id];
    if (btn) { btn.textContent = '+ –í –ö–û–†–ó–ò–ù–£'; btn.classList.remove('in-cart'); }
  } else {
    cart[id] = 1;
    if (btn) { btn.textContent = '‚úì –í –ö–û–†–ó–ò–ù–ï'; btn.classList.add('in-cart'); }
    showToast('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É', true);
  }
  updateCartBadge();
  if (currentProduct?.id === id) updateModalCartBtn();
}

function toggleCartFromModal() {
  if (!currentProduct) return;
  toggleCart(currentProduct.id, null);
  updateModalCartBtn();
  // re-render card button in grid
  renderCatalog();
}

function updateModalCartBtn() {
  const btn = document.getElementById('modalCartBtn');
  if (inCart(currentProduct?.id)) {
    btn.textContent = '‚úì –í –ö–û–†–ó–ò–ù–ï';
    btn.classList.add('in-cart');
  } else {
    btn.textContent = '+ –í –ö–û–†–ó–ò–ù–£';
    btn.classList.remove('in-cart');
  }
}

// ‚îÄ‚îÄ‚îÄ PRODUCT MODAL ‚îÄ‚îÄ‚îÄ
function openProduct(id) {
  currentProduct = products.find(p => p.id === id);
  if (!currentProduct) return;
  const p = currentProduct;
  const imgEl = document.getElementById('modalImg');
  imgEl.innerHTML = (p.img ? `<img src="${p.img}" alt="">` : (p.emoji||'üì¶'))
    + `<div class="modal-img-overlay"></div>`;
  document.getElementById('modalCat').textContent = p.category;
  document.getElementById('modalName').textContent = p.name;
  document.getElementById('modalDesc').textContent = p.desc || '‚Äî';
  document.getElementById('modalPrice').textContent = fmt(p.price);
  document.getElementById('modalOld').textContent = p.oldPrice ? fmt(p.oldPrice) : '';
  updateModalCartBtn();
  document.getElementById('productOverlay').classList.add('open');
}

function closeModal() { document.getElementById('productOverlay').classList.remove('open'); }
function closeProductModal(e) { if (e.target.id === 'productOverlay') closeModal(); }

// ‚îÄ‚îÄ‚îÄ CART PANEL ‚îÄ‚îÄ‚îÄ
function openCart() {
  renderCartPanel();
  document.getElementById('cartOverlay').classList.add('open');
}
function closeCart() { document.getElementById('cartOverlay').classList.remove('open'); }
function closeCartModal(e) { if (e.target.id === 'cartOverlay') closeCart(); }

function renderCartPanel() {
  const keys = Object.keys(cart).filter(id => cart[id] > 0);
  const itemsEl = document.getElementById('cartItems');
  document.getElementById('cartTotal').textContent = fmt(cartTotal());
  document.getElementById('orderBtn').disabled = keys.length === 0;

  if (!keys.length) {
    itemsEl.innerHTML = `<div class="cart-empty"><span class="cart-empty-icon">üõí</span><p>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p></div>`;
    return;
  }
  itemsEl.innerHTML = keys.map(id => {
    const p = products.find(x => x.id === +id);
    if (!p) return '';
    const qty = cart[id];
    const thumb = p.img ? `<img src="${p.img}" alt="">` : (p.emoji||'üì¶');
    return `<div class="cart-item" id="ci-${id}">
      <div class="cart-item-img">${thumb}</div>
      <div class="cart-item-info">
        <div class="cart-item-name">${p.name}</div>
        <div class="cart-item-price">${fmt(p.price)} √ó ${qty} = ${fmt(p.price*qty)}</div>
      </div>
      <div class="cart-item-qty">
        <button class="qty-btn" onclick="changeQty(${id},-1)">‚àí</button>
        <span class="qty-num">${qty}</span>
        <button class="qty-btn" onclick="changeQty(${id},+1)">+</button>
      </div>
    </div>`;
  }).join('');
}

function changeQty(id, delta) {
  const newQty = (cart[id] || 0) + delta;
  if (newQty <= 0) {
    delete cart[id];
  } else {
    cart[id] = newQty;
  }
  updateCartBadge();
  renderCartPanel();
  renderCatalog();
}

// ‚îÄ‚îÄ‚îÄ ORDER ‚îÄ‚îÄ‚îÄ
function sendOrder() {
  const keys = Object.keys(cart).filter(id => cart[id] > 0);
  if (!keys.length) return;

  const lines = keys.map(id => {
    const p = products.find(x => x.id === +id);
    return `${p.name} √ó ${cart[id]} = ${fmt(p.price * cart[id])}`;
  });
  const total = fmt(cartTotal());
  const text = `üõí –ù–û–í–´–ô –ó–ê–ö–ê–ó\n\n${lines.join('\n')}\n\nüí∞ –ò—Ç–æ–≥–æ: ${total}`;

  const u = (settings.username || '').replace('@','').trim();
  if (u) {
    window.open(`https://t.me/${u}?text=${encodeURIComponent(text)}`, '_blank');
  } else if (window.Telegram?.WebApp) {
    Telegram.WebApp.sendData(text);
  } else {
    alert('–ù–∞—Å—Ç—Ä–æ–π—Ç–µ @username –≤ –ø–∞–Ω–µ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!');
    return;
  }
  showToast('–ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', true);
  cart = {};
  updateCartBadge();
  closeCart();
  renderCatalog();
}

// ‚îÄ‚îÄ‚îÄ PIN / ADMIN ‚îÄ‚îÄ‚îÄ
function openPinOverlay() {
  document.getElementById('pinInput').value = '';
  document.getElementById('pinError').style.display = 'none';
  document.getElementById('pinOverlay').style.display = 'flex';
}
function checkPin() {
  if (document.getElementById('pinInput').value === settings.pass) {
    document.getElementById('pinOverlay').style.display = 'none';
    openAdmin();
  } else {
    document.getElementById('pinError').style.display = 'block';
  }
}

function openAdmin() {
  document.getElementById('adminOverlay').classList.add('open');
  document.getElementById('settingName').value = settings.name || '';
  document.getElementById('settingPass').value = '';
  document.getElementById('settingUsername').value = settings.username || '';
  document.getElementById('settingBinKey').value = settings.binKey || '';
  document.getElementById('settingBinId').value = settings.binId || '';
  renderCatChips(); renderCatSelect(); renderAdminProducts(); cancelEdit(); showStorageInfo(); showCloudStatus();
}
function closeAdmin() {
  document.getElementById('adminOverlay').classList.remove('open');
  renderCatalog();
}

function saveSettings() {
  const n = document.getElementById('settingName').value.trim();
  const p = document.getElementById('settingPass').value.trim();
  const u = document.getElementById('settingUsername').value.trim();
  const bk = document.getElementById('settingBinKey').value.trim();
  const bi = document.getElementById('settingBinId').value.trim();
  if (n) settings.name = n;
  if (p) settings.pass = p;
  settings.username = u;
  if (bk) settings.binKey = bk;
  if (bi) settings.binId = bi;
  persist();
  showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', true);
}

// ‚îÄ‚îÄ‚îÄ STORAGE TOOLS ‚îÄ‚îÄ‚îÄ
function showStorageInfo() {
  try {
    let total = 0;
    for (let k in localStorage) {
      if (localStorage.hasOwnProperty(k)) total += (localStorage[k].length + k.length) * 2;
    }
    const used = (total / 1024 / 1024).toFixed(2);
    const pct = Math.min(100, Math.round(total / 1024 / 1024 / 5 * 100));
    const color = pct > 80 ? "var(--red)" : pct > 60 ? "#ff9900" : "#34d399";
    const label = pct > 80 ? "‚ö† –ú–ê–õ–û –ú–ï–°–¢–ê" : pct > 60 ? "–ó–ê–ü–û–õ–ù–ï–ù–û" : "–û–ö";

    const bar = document.getElementById("storageBar");
    const text = document.getElementById("storageText");
    const hint = document.getElementById("storageHint");

    if (bar) { bar.style.width = pct + "%"; bar.style.background = color; bar.style.boxShadow = `0 0 10px ${color}`; }
    if (text) { text.textContent = used + " –ú–ë / 5 –ú–ë"; text.style.color = color; }
    if (hint) { hint.textContent = pct + "% ‚Äî " + label; hint.style.color = color; }
  } catch(e) {}
}

function showCloudStatus() {
  const el = document.getElementById('cloudStatus');
  if (!el) return;
  const keyOk = !!(settings.binKey || DEFAULT_BIN_KEY);
  const binOk = !!(settings.binId  || DEFAULT_BIN_ID);
  if (keyOk && binOk) {
    const src = DEFAULT_BIN_KEY ? '–≤—à–∏—Ç—ã –≤ —Ñ–∞–π–ª' : '–≤–≤–µ–¥–µ–Ω—ã –≤—Ä—É—á–Ω—É—é';
    el.style.borderColor = '#34d399';
    el.style.color = '#34d399';
    el.textContent = '‚úì –û–ë–õ–ê–ö–û –ü–û–î–ö–õ–Æ–ß–ï–ù–û ‚Äî –∫–ª—é—á–∏ ' + src;
  } else {
    el.style.borderColor = '#ff9900';
    el.style.color = '#ff9900';
    el.textContent = '‚ö† –û–ë–õ–ê–ö–û –ù–ï –ù–ê–°–¢–†–û–ï–ù–û ‚Äî –≤–≤–µ–¥–∏—Ç–µ API KEY –∏ BIN ID';
  }
}

function compressBase64(b64, maxPx, quality) {
  return new Promise(resolve => {
    if (!b64 || !b64.startsWith("data:image")) { resolve(b64); return; }
    const img = new Image();
    img.onload = () => {
      let w = img.width, h = img.height;
      if (w > maxPx || h > maxPx) {
        if (w >= h) { h = Math.round(h * maxPx / w); w = maxPx; }
        else { w = Math.round(w * maxPx / h); h = maxPx; }
      }
      const c = document.createElement("canvas");
      c.width = w; c.height = h;
      c.getContext("2d").drawImage(img, 0, 0, w, h);
      resolve(c.toDataURL("image/jpeg", quality));
    };
    img.onerror = () => resolve(b64);
    img.src = b64;
  });
}


// ‚îÄ‚îÄ‚îÄ CATEGORIES ‚îÄ‚îÄ‚îÄ
function renderCatChips() {
  document.getElementById('catChips').innerHTML = categories.filter(c=>c!=='–í—Å–µ').map(c=>
    `<div class="cat-chip">${c} <button onclick="removeCategory('${c}')">√ó</button></div>`
  ).join('');
}
function renderCatSelect() {
  document.getElementById('fCat').innerHTML = categories.filter(c=>c!=='–í—Å–µ').map(c=>`<option>${c}</option>`).join('');
}
function addCategory() {
  const v = document.getElementById('newCatInput').value.trim();
  if (!v || categories.includes(v)) return;
  categories.push(v); persist();
  document.getElementById('newCatInput').value = '';
  renderCatChips(); renderCatSelect();
}
function removeCategory(c) {
  categories = categories.filter(x=>x!==c);
  products.forEach(p => { if(p.category===c) p.category = categories.find(x=>x!=='–í—Å–µ') || '–û—Å–Ω–æ–≤–Ω–æ–µ'; });
  persist(); renderCatChips(); renderCatSelect(); renderAdminProducts();
}

// ‚îÄ‚îÄ‚îÄ URL PHOTO ‚îÄ‚îÄ‚îÄ
function previewUrl() {
  const url = document.getElementById('fImgUrl').value.trim();
  const prev = document.getElementById('urlPreview');
  if (url) {
    prev.src = url;
    prev.style.display = 'block';
    prev.onerror = () => { prev.style.display = 'none'; };
  } else {
    prev.style.display = 'none';
    prev.src = '';
  }
}

function applyUrl() {
  const url = document.getElementById('fImgUrl').value.trim();
  if (!url) { showToast('–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ!'); return; }
  previewUrl();
  showToast('–§–æ—Ç–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ!', true);
}

// ‚îÄ‚îÄ‚îÄ PRODUCT CRUD ‚îÄ‚îÄ‚îÄ
function renderAdminProducts() {
  const el = document.getElementById('adminProductList');
  if (!products.length) {
    el.innerHTML = `<div style="color:var(--grey);text-align:center;padding:24px;font-family:'Barlow Condensed',sans-serif;letter-spacing:2px;text-transform:uppercase;font-size:13px">// –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ //</div>`;
    return;
  }
  el.innerHTML = products.map(p => {
    const thumb = p.img ? `<img src="${p.img}" alt="">` : (p.emoji||'üì¶');
    const hiddenClass = p.hidden ? ' hidden-product' : '';
    const hideLabel = p.hidden ? 'üëÅ –ü–û–ö–ê–ó–ê–¢–¨' : 'üö´ –°–ö–†–´–¢–¨';
    const hideBtnClass = p.hidden ? ' is-hidden' : '';
    return `<div class="product-item${hiddenClass}" draggable="true" data-id="${p.id}">
      <div class="drag-handle" title="–ü–µ—Ä–µ—Ç–∞—â–∏—Ç—å">‚†ø</div>
      <div class="product-item-thumb">${thumb}</div>
      <div class="product-item-info">
        <div class="product-item-name">${p.hidden ? 'üö´ ' : ''}${p.name}</div>
        <div class="product-item-meta">${p.category} ¬∑ ${fmt(p.price)}</div>
      </div>
      <div class="product-item-actions">
        <button class="btn-hide${hideBtnClass}" onclick="toggleHide(${p.id})" title="${hideLabel}">${p.hidden ? 'üëÅ' : 'üö´'}</button>
        <button class="btn-edit" onclick="editProduct(${p.id})">‚úè</button>
        <button class="btn-del" onclick="deleteProduct(${p.id})">üóë</button>
      </div>
    </div>`;
  }).join('');
  setupDragSort();
}

function saveProduct() {
  const name = document.getElementById('fName').value.trim();
  const price = parseFloat(document.getElementById('fPrice').value);
  if (!name || isNaN(price)) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Ü–µ–Ω—É!'); return; }

  const editId = document.getElementById('editingId').value;
  const old = editId ? products.find(p=>p.id===+editId) : null;
  const prod = {
    id: editId ? +editId : Date.now(),
    name,
    desc: document.getElementById('fDesc').value.trim(),
    category: document.getElementById('fCat').value || (categories.find(c=>c!=='–í—Å–µ') || '–û—Å–Ω–æ–≤–Ω–æ–µ'),
    price,
    oldPrice: parseFloat(document.getElementById('fOldPrice').value) || '',
    emoji: document.getElementById('fEmoji').value.trim() || 'üì¶',
    img: document.getElementById('fImgUrl').value.trim() || (old ? old.img : ''),
  };

  if (editId) {
    const idx = products.findIndex(p=>p.id===prod.id);
    if (idx > -1) products[idx] = prod;
  } else {
    products.push(prod);
  }
  persist();
  cancelEdit();
  renderAdminProducts();
  showToast(editId ? '–¢–æ–≤–∞—Ä –æ–±–Ω–æ–≤–ª—ë–Ω!' : '–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!', true);
}

function editProduct(id) {
  const p = products.find(x=>x.id===id);
  if (!p) return;
  document.getElementById('editingId').value = p.id;
  document.getElementById('fName').value = p.name;
  document.getElementById('fDesc').value = p.desc || '';
  document.getElementById('fCat').value = p.category;
  document.getElementById('fPrice').value = p.price;
  document.getElementById('fOldPrice').value = p.oldPrice || '';
  document.getElementById('fEmoji').value = p.emoji || '';
  document.getElementById('fImgUrl').value = (p.img && !p.img.startsWith('data:')) ? p.img : '';
  document.getElementById('urlPreview').src = (p.img && !p.img.startsWith('data:')) ? p.img : '';
  document.getElementById('urlPreview').style.display = (p.img && !p.img.startsWith('data:')) ? 'block' : 'none';
  document.getElementById('formTitle').textContent = '‚ñ∂ –†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨ –¢–û–í–ê–†';
  document.getElementById('cancelEditBtn').classList.add('visible');

  document.getElementById('fName').scrollIntoView({ behavior:'smooth', block:'center' });
}

function toggleHide(id) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  p.hidden = !p.hidden;
  persist();
  renderAdminProducts();
  renderCatalog();
  showToast(p.hidden ? 'üö´ –¢–æ–≤–∞—Ä —Å–∫—Ä—ã—Ç' : 'üëÅ –¢–æ–≤–∞—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è', true);
}

// ‚îÄ‚îÄ‚îÄ DRAG & SORT ‚îÄ‚îÄ‚îÄ
let dragSrcId = null;

function setupDragSort() {
  const items = document.querySelectorAll('.product-item[draggable]');
  items.forEach(item => {
    item.addEventListener('dragstart', e => {
      dragSrcId = +item.dataset.id;
      item.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    item.addEventListener('dragend', () => {
      item.classList.remove('dragging');
      document.querySelectorAll('.product-item').forEach(i => i.classList.remove('drag-over'));
    });
    item.addEventListener('dragover', e => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      document.querySelectorAll('.product-item').forEach(i => i.classList.remove('drag-over'));
      item.classList.add('drag-over');
    });
    item.addEventListener('drop', e => {
      e.preventDefault();
      const targetId = +item.dataset.id;
      if (dragSrcId === targetId) return;
      const srcIdx = products.findIndex(p => p.id === dragSrcId);
      const tgtIdx = products.findIndex(p => p.id === targetId);
      if (srcIdx < 0 || tgtIdx < 0) return;
      // Reorder
      const [moved] = products.splice(srcIdx, 1);
      products.splice(tgtIdx, 0, moved);
      persist();
      renderAdminProducts();
      renderCatalog();
    });
  });
}

function deleteProduct(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')) return;
  products = products.filter(p=>p.id!==id);
  delete cart[id];
  persist(); updateCartBadge(); renderAdminProducts();
  showToast('–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω');
}

function cancelEdit() {
  document.getElementById('editingId').value = '';
  document.getElementById('fName').value = '';
  document.getElementById('fDesc').value = '';
  document.getElementById('fPrice').value = '';
  document.getElementById('fOldPrice').value = '';
  document.getElementById('fEmoji').value = '';
  document.getElementById('fImgUrl').value = '';
  document.getElementById('urlPreview').src = '';
  document.getElementById('urlPreview').style.display = 'none';
  document.getElementById('formTitle').textContent = '‚ñ∂ –î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†';
  document.getElementById('cancelEditBtn').classList.remove('visible');
}

// ‚îÄ‚îÄ‚îÄ CLOUD SYNC (JSONBin.io) ‚îÄ‚îÄ‚îÄ
function hasCloud() {
  return (settings.binKey || DEFAULT_BIN_KEY) && (settings.binId || DEFAULT_BIN_ID);
}

function getCloudKey() { return settings.binKey || DEFAULT_BIN_KEY; }
function getCloudBin() { return settings.binId  || DEFAULT_BIN_ID; }

async function cloudSave() {
  if (!hasCloud()) return false;
  try {
    // –í–ê–ñ–ù–û: base64 —Ñ–æ—Ç–æ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ–±–ª–∞–∫–æ ‚Äî –æ–Ω–∏ —Å–ª–∏—à–∫–æ–º —Ç—è–∂—ë–ª—ã–µ (–ª–∏–º–∏—Ç JSONBin 100KB)
    // –§–æ—Ç–æ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ –∫–∞–∂–¥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
    const cloudProducts = products.map(p => ({
      id: p.id,
      name: p.name,
      desc: p.desc,
      category: p.category,
      price: p.price,
      oldPrice: p.oldPrice,
      emoji: p.emoji,
      img: p.img && p.img.startsWith('data:') ? '' : p.img  // URL —Ñ–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º, base64 ‚Äî –Ω–µ—Ç
    }));

    const data = {
      products: cloudProducts,
      categories,
      settings: { name: settings.name, username: settings.username }
    };

    const json = JSON.stringify(data);
    const sizeKb = Math.round(json.length / 1024);
    console.log('Cloud payload size:', sizeKb, 'KB');
    if (sizeKb > 95) {
      showToast('‚úó –î–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ (' + sizeKb + 'KB). –£–±–µ—Ä–∏—Ç–µ –ª–∏—à–Ω–µ–µ.', false);
      return false;
    }

    const res = await fetch(`https://api.jsonbin.io/v3/b/${getCloudBin()}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': getCloudKey(),
        'X-Bin-Versioning': 'false',
        'X-Bin-Private': 'false'
      },
      body: json
    });

    if (!res.ok) {
      const err = await res.text();
      console.error('CloudSave error:', res.status, err);
      showToast('‚úó –û—à–∏–±–∫–∞ ' + res.status + ': ' + err.slice(0,50), false);
    }
    return res.ok;
  } catch(e) {
    console.error('CloudSave exception:', e);
    showToast('‚úó –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', false);
    return false;
  }
}

async function cloudLoad(force = false) {
  if (!hasCloud()) return false;
  try {
    const res = await fetch(`https://api.jsonbin.io/v3/b/${getCloudBin()}/latest`, {
      headers: { 'X-Master-Key': getCloudKey() }
    });
    if (!res.ok) return false;
    const json = await res.json();
    const data = json.record;
    if (!data.products || !Array.isArray(data.products)) return false;

    // Only load from cloud if it has products, OR if force=true (manual sync button)
    if (!force && data.products.length === 0) return false;

    products = data.products;
    categories = data.categories || ['–í—Å–µ'];
    if (!categories.includes('–í—Å–µ')) categories.unshift('–í—Å–µ');
    const localPass = settings.pass;
    const localKey = settings.binKey;
    const localBinId = settings.binId;
    if (data.settings) settings = { ...data.settings, pass: localPass, binKey: localKey, binId: localBinId };
    persist(false); // save locally but don't trigger cloud save loop
    return true;
  } catch(e) { return false; }
}

async function syncCloud() {
  const btn = document.getElementById('syncBtn');
  if (!hasCloud()) { showToast('–°–Ω–∞—á–∞–ª–∞ –≤–≤–µ–¥–∏—Ç–µ API KEY –∏ BIN ID!'); return; }

  const action = confirm(
    '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:\n\n' +
    'OK ‚Äî –ó–ê–ì–†–£–ó–ò–¢–¨ –∏–∑ –æ–±–ª–∞–∫–∞ (–∑–∞–º–µ–Ω–∏—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)\n' +
    '–û—Ç–º–µ–Ω–∞ ‚Äî –í–´–ì–†–£–ó–ò–¢–¨ –≤ –æ–±–ª–∞–∫–æ (–ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –æ–±–ª–∞–∫–æ)'
  );

  if (btn) { btn.textContent = '‚è≥ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è...'; btn.disabled = true; }

  let ok;
  if (action) {
    // Download from cloud
    ok = await cloudLoad(true);
    renderCatalog(); renderAdminProducts(); renderCatChips(); renderCatSelect(); showStorageInfo();
    showToast(ok ? '‚úì –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞!' : '‚úó –û—à–∏–±–∫–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏', ok);
  } else {
    // Upload to cloud ‚Äî test with GET first to validate keys
    if (btn) btn.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–π...';
    try {
      const testRes = await fetch(`https://api.jsonbin.io/v3/b/${getCloudBin()}/latest`, {
        headers: { 'X-Master-Key': getCloudKey() }
      });
      if (!testRes.ok) {
        const errText = await testRes.text();
        showToast(`‚úó –û—à–∏–±–∫–∞ ${testRes.status}: ${errText.slice(0,60)}`, false);
        if (btn) { btn.textContent = '‚òÅ –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–¢–¨ –° –û–ë–õ–ê–ö–û–ú'; btn.disabled = false; }
        return;
      }
      if (btn) btn.textContent = '‚è≥ –í—ã–≥—Ä—É–∂–∞—é...';
      ok = await cloudSave();
      showToast(ok ? '‚úì –î–∞–Ω–Ω—ã–µ –≤—ã–≥—Ä—É–∂–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ!' : '‚úó –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', ok);
    } catch(e) {
      showToast('‚úó –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + e.message.slice(0,40), false);
    }
  }

  if (btn) { btn.textContent = '‚òÅ –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–¢–¨ –° –û–ë–õ–ê–ö–û–ú'; btn.disabled = false; }
}

// ‚îÄ‚îÄ‚îÄ EXPORT / IMPORT ‚îÄ‚îÄ‚îÄ
function exportData() {
  const data = {
    products,
    categories,
    settings,
    exportedAt: new Date().toISOString(),
    version: 2
  };
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'catalog-backup.json';
  a.click();
  URL.revokeObjectURL(url);
  showToast('–§–∞–π–ª —Å–∫–∞—á–∞–Ω!', true);
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.products || !Array.isArray(data.products)) {
        showToast('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞!'); return;
      }
      if (!confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${data.products.length} —Ç–æ–≤–∞—Ä–æ–≤? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.`)) return;
      products = data.products;
      categories = data.categories || ['–í—Å–µ'];
      if (!categories.includes('–í—Å–µ')) categories.unshift('–í—Å–µ');
      if (data.settings) settings = data.settings;
      persist();
      renderCatChips(); renderCatSelect(); renderAdminProducts();
      showStorageInfo();
      renderCatalog();
      showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${products.length} —Ç–æ–≤–∞—Ä–æ–≤!`, true);
    } catch(err) {
      showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞!');
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// ‚îÄ‚îÄ‚îÄ TELEGRAM ‚îÄ‚îÄ‚îÄ
if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); }

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ
if (!categories.includes('–í—Å–µ')) categories.unshift('–í—Å–µ');
updateCartBadge();
// Auto-load from cloud on start
if (hasCloud()) {
  cloudLoad().then(ok => {
    renderCatalog();
    if (ok) console.log('Loaded from cloud');
  });
} else {
  renderCatalog();
}
</script>
</body>
</html>
